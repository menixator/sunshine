<!DOCTYPE html>

<html>
<head>
  <title>plantprofile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="formatter.html">
                  formatter.js
                </a>
              
                
                <a class="source" href="normalize.html">
                  normalize.js
                </a>
              
                
                <a class="source" href="alldata.html">
                  alldata.js
                </a>
              
                
                <a class="source" href="authentication.html">
                  authentication.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="data.html">
                  data.js
                </a>
              
                
                <a class="source" href="dayoverview.html">
                  dayoverview.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="lastdataexact.html">
                  lastdataexact.js
                </a>
              
                
                <a class="source" href="logout.html">
                  logout.js
                </a>
              
                
                <a class="source" href="monthoverview.html">
                  monthoverview.js
                </a>
              
                
                <a class="source" href="plantlist.html">
                  plantlist.js
                </a>
              
                
                <a class="source" href="plantprofile.html">
                  plantprofile.js
                </a>
              
                
                <a class="source" href="plantrequest.html">
                  plantrequest.js
                </a>
              
                
                <a class="source" href="yearoverview.html">
                  yearoverview.js
                </a>
              
                
                <a class="source" href="alldata.html">
                  alldata.js
                </a>
              
                
                <a class="source" href="authentication.html">
                  authentication.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="data.html">
                  data.js
                </a>
              
                
                <a class="source" href="dayoverview.html">
                  dayoverview.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="lastdataexact.html">
                  lastdataexact.js
                </a>
              
                
                <a class="source" href="monthoverview.html">
                  monthoverview.js
                </a>
              
                
                <a class="source" href="overview.html">
                  overview.js
                </a>
              
                
                <a class="source" href="plantlist.html">
                  plantlist.js
                </a>
              
                
                <a class="source" href="plantprofile.html">
                  plantprofile.js
                </a>
              
                
                <a class="source" href="yearoverview.html">
                  yearoverview.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="sunshine.html">
                  sunshine.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>plantprofile.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Base = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./base"</span>);
<span class="hljs-keyword">const</span> XRegExp = <span class="hljs-built_in">require</span>(<span class="hljs-string">"xregexp"</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlantProfile</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Base</span> </span>{
  parse() {
    <span class="hljs-keyword">this</span>.name = <span class="hljs-keyword">this</span>.findOneText(<span class="hljs-string">"name"</span>, <span class="hljs-keyword">this</span>.contextNode);

    <span class="hljs-keyword">this</span>.peakPower = {
      <span class="hljs-attr">value</span>: <span class="hljs-keyword">this</span>.findOneText(<span class="hljs-string">"peak-power"</span>, <span class="hljs-keyword">this</span>.contextNode),
      <span class="hljs-attr">unit</span>: <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"unit"</span>, <span class="hljs-string">"peak-power"</span>, <span class="hljs-keyword">this</span>.contextNode)
    };

    <span class="hljs-keyword">this</span>.location = <span class="hljs-keyword">this</span>.findOneText(<span class="hljs-string">"city-country"</span>, <span class="hljs-keyword">this</span>.contextNode);
    <span class="hljs-keyword">this</span>.startDate = <span class="hljs-keyword">this</span>.findOneText(<span class="hljs-string">"start-date"</span>, <span class="hljs-keyword">this</span>.contextNode);

    <span class="hljs-keyword">this</span>.data = {};

    <span class="hljs-keyword">let</span> channels = <span class="hljs-keyword">this</span>.findAll(<span class="hljs-string">"production-data/channel"</span>, <span class="hljs-keyword">this</span>.contextNode);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> channel <span class="hljs-keyword">of</span> channels) {
      <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"meta-name"</span>, channel)) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"Energy"</span>:
          <span class="hljs-keyword">this</span>.parseChannel(channel, <span class="hljs-string">"energyPerAnnum"</span>).annum = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-string">"CO2-Reduction"</span>:
          <span class="hljs-keyword">this</span>.parseChannel(channel, <span class="hljs-string">"co2ReductionPerAnnum"</span>).annum = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">default</span>:
          <span class="hljs-keyword">this</span>.log<span class="hljs-string">`unknown channel <span class="hljs-subst">${<span class="hljs-keyword">this</span>.ptr(
            channel
          )}</span> with meta-name: <span class="hljs-subst">${<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"meta-name"</span>, channel)}</span>`</span>;
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
            <span class="hljs-string">`unknown channel with meta-name: <span class="hljs-subst">${<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"meta-name"</span>, channel)}</span>`</span>
          );
      }
    }

    <span class="hljs-keyword">this</span>.inverters = [];

    <span class="hljs-keyword">let</span> inverters = <span class="hljs-keyword">this</span>.findAll(<span class="hljs-string">"inverters/inverter"</span>, <span class="hljs-keyword">this</span>.contextNode);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> inverter <span class="hljs-keyword">of</span> inverters) {
      <span class="hljs-keyword">this</span>.inverters.push({
        <span class="hljs-attr">count</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"count"</span>, inverter)),
        <span class="hljs-attr">icon</span>: <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"deviceIcon"</span>, inverter),
        <span class="hljs-attr">descr</span>: inverter.textContent
      });
    }

    <span class="hljs-keyword">this</span>.coms = [];

    <span class="hljs-keyword">let</span> coms = <span class="hljs-keyword">this</span>.findAll(<span class="hljs-string">"communicationProducts/communicationProduct"</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> com <span class="hljs-keyword">of</span> coms) {
      <span class="hljs-keyword">this</span>.coms.push({
        <span class="hljs-attr">count</span>: <span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"count"</span>, com)),
        <span class="hljs-attr">icon</span>: <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"deviceIcon"</span>, com),
        <span class="hljs-attr">descr</span>: com.textContent
      });
    }
  }

  parseChannel(channel, key) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: Reaplce</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data.hasOwnProperty(key)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(
        <span class="hljs-string">`a data hash with the key <span class="hljs-subst">${key}</span> has already been defined`</span>
      );
    }

    <span class="hljs-keyword">let</span> value = channel.textContent;
    <span class="hljs-keyword">let</span> fallBackUnit = <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"unit"</span>, channel);

    <span class="hljs-keyword">let</span> chan = {
      <span class="hljs-attr">metaName</span>: <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"meta-name"</span>, channel),
      <span class="hljs-attr">name</span>: <span class="hljs-keyword">this</span>.attr(<span class="hljs-string">"name"</span>, channel),
      <span class="hljs-attr">readings</span>: []
    };

    chan.approximated = !!value.match(<span class="hljs-regexp">/approx/i</span>);
    chan.annum = !!value.match(<span class="hljs-regexp">/annum|annually/</span>);

    XRegExp.forEach(value, PlantProfile.VALUE_PARSER, (match, idx) =&gt; {
      <span class="hljs-keyword">let</span> reading = {
        <span class="hljs-attr">value</span>: <span class="hljs-built_in">parseFloat</span>(match.value.replace(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">""</span>), <span class="hljs-number">10</span>)
      };

      <span class="hljs-keyword">if</span> (match.units) {
        reading.units = match.units.trim().split(<span class="hljs-string">"/"</span>);
      } <span class="hljs-keyword">else</span> {
        reading.units = [];
      }
      chan.readings.push(reading);
    });

    <span class="hljs-keyword">if</span> (chan.readings.length === <span class="hljs-number">1</span> &amp;&amp; chan.readings[<span class="hljs-number">0</span>].units.length === <span class="hljs-number">0</span>) {
      chan.readings.units.push(fallBackUnit);
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = chan.readings.length - <span class="hljs-number">1</span>; --i &gt; <span class="hljs-number">0</span>; ) {
      <span class="hljs-keyword">if</span> (chan.readings[i].units.length === <span class="hljs-number">0</span>) {
        chan.readings.splice(i, <span class="hljs-number">1</span>);
      }
    }

    <span class="hljs-keyword">this</span>.data[key] = chan;
    <span class="hljs-keyword">return</span> chan;
  }
}

PlantProfile.VALUE_PARSER = XRegExp(
  <span class="hljs-string">`
(?&lt;value&gt;[\\d,]+(?:\\.\\d*)?)
(?&lt;units&gt; \\s* [a-z]{1,} (\\s*[/]\\s*[a-z]{1,}) *)?
`</span>,
  <span class="hljs-string">"xig"</span>
);
<span class="hljs-built_in">module</span>.exports = PlantProfile;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
