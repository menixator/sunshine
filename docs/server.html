<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="formatter.html">
                  formatter.js
                </a>
              
                
                <a class="source" href="normalize.html">
                  normalize.js
                </a>
              
                
                <a class="source" href="alldata.html">
                  alldata.js
                </a>
              
                
                <a class="source" href="authentication.html">
                  authentication.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="data.html">
                  data.js
                </a>
              
                
                <a class="source" href="dayoverview.html">
                  dayoverview.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="lastdataexact.html">
                  lastdataexact.js
                </a>
              
                
                <a class="source" href="logout.html">
                  logout.js
                </a>
              
                
                <a class="source" href="monthoverview.html">
                  monthoverview.js
                </a>
              
                
                <a class="source" href="plantlist.html">
                  plantlist.js
                </a>
              
                
                <a class="source" href="plantprofile.html">
                  plantprofile.js
                </a>
              
                
                <a class="source" href="plantrequest.html">
                  plantrequest.js
                </a>
              
                
                <a class="source" href="yearoverview.html">
                  yearoverview.js
                </a>
              
                
                <a class="source" href="alldata.html">
                  alldata.js
                </a>
              
                
                <a class="source" href="authentication.html">
                  authentication.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="data.html">
                  data.js
                </a>
              
                
                <a class="source" href="dayoverview.html">
                  dayoverview.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="lastdataexact.html">
                  lastdataexact.js
                </a>
              
                
                <a class="source" href="monthoverview.html">
                  monthoverview.js
                </a>
              
                
                <a class="source" href="overview.html">
                  overview.js
                </a>
              
                
                <a class="source" href="plantlist.html">
                  plantlist.js
                </a>
              
                
                <a class="source" href="plantprofile.html">
                  plantprofile.js
                </a>
              
                
                <a class="source" href="yearoverview.html">
                  yearoverview.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="sunshine.html">
                  sunshine.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);
<span class="hljs-keyword">const</span> Sunshine = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./sunshine"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">"socket.io"</span>);
<span class="hljs-keyword">const</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">"debug"</span>);

<span class="hljs-keyword">let</span> log = debug(<span class="hljs-string">"sunshine:http"</span>);
<span class="hljs-keyword">let</span> app = express();
<span class="hljs-keyword">let</span> server = http.createServer(app);
<span class="hljs-keyword">let</span> socks = io(server);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>const AGGREGATION_ROOM = ‘aggregation’;
const PLANT_ROOM_PREFIX=’plant:’;
const AGGREGATION_ROOM_SUBSCRIBE=’sunny::aggregation.subscribe’;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> bot = <span class="hljs-keyword">new</span> Sunshine({
  <span class="hljs-attr">username</span>: <span class="hljs-string">"ahmed.miljau@gmail.com"</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">"cipeqeza"</span>
});</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Gets the population of a room.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRoomPopulation</span>(<span class="hljs-params">room</span>) </span>{
  <span class="hljs-keyword">if</span> (
    !<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(socks.sockets.adapter.rooms, room)
  ) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">return</span> socks.sockets.adapter.rooms[room].length;
}

<span class="hljs-keyword">let</span> cacheClearTimeout = <span class="hljs-literal">null</span>;

socks.of(<span class="hljs-string">"/"</span>).on(<span class="hljs-string">"connection"</span>, sock =&gt; {
  <span class="hljs-keyword">if</span> (cacheClearTimeout) clearTimeout(cacheClearTimeout);

  sock.on(<span class="hljs-string">"sunny::aggregation.subscribe"</span>, () =&gt; {
    log(<span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) wants to join the aggregation room`</span>);
    sock.join(<span class="hljs-string">"aggregation"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> log(
          <span class="hljs-string">`failed to add <span class="hljs-subst">${sock.id}</span> to aggregation room due to err: <span class="hljs-subst">${err.message}</span>`</span>
        );

      log(
        <span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) has joined the aggregation room. emitting poll status now.`</span>
      );
      sock.emit(<span class="hljs-string">"sunny::aggregation.status"</span>, !!bot.polling);

      <span class="hljs-keyword">if</span> (!bot.polling) {
        log(<span class="hljs-string">`making the bot start the aggregation now`</span>);
        bot.startAggregation(<span class="hljs-number">20000</span>);
      } <span class="hljs-keyword">else</span> {
        log(<span class="hljs-string">`bot was already aggregating. good bot.`</span>);
      }

      <span class="hljs-keyword">var</span> initialEvent = bot.toAggregationEvent();

      <span class="hljs-keyword">if</span> (initialEvent) {
        log(<span class="hljs-string">"sending initial event"</span>);
        sock.emit(<span class="hljs-string">"sunny::aggregation.tick"</span>, initialEvent);
      }
    });
  });

  sock.on(<span class="hljs-string">"sunny::aggregation.unsubscribe"</span>, () =&gt; {
    log(<span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) wants to leave the aggregation room`</span>);

    sock.leave(<span class="hljs-string">"aggregation"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> log(
          <span class="hljs-string">`failed to remove <span class="hljs-subst">${sock.id}</span> from aggregation room due to err: <span class="hljs-subst">${err.message}</span>`</span>
        );</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Adding a timeout to account for refreshes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (getRoomPopulation(<span class="hljs-string">"aggregation"</span>) === <span class="hljs-number">0</span>) {
        log(<span class="hljs-string">`stopping aggregation`</span>);
        bot.stopAggregation();
      }
    });
  });

  sock.on(<span class="hljs-string">"sunny::plant.subscribe"</span>, ({ oid }) =&gt; {
    <span class="hljs-keyword">let</span> roomId = <span class="hljs-string">"plant:"</span> + oid;
    log(
      <span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) wants to start subscribing to plant room: <span class="hljs-subst">${roomId}</span>`</span>
    );
    sock.join(roomId, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> log(
          <span class="hljs-string">`failed to add <span class="hljs-subst">${sock.id}</span> to from plant room(<span class="hljs-subst">${roomId}</span>) room due to err: <span class="hljs-subst">${err.message}</span>`</span>
        );

      log(<span class="hljs-string">`adding plant to bot`</span>);
      bot.addSoloPlant(oid);

      <span class="hljs-keyword">if</span> (bot.cache.plants.has(oid) &amp;&amp; bot.cache.plants.get(oid) !== <span class="hljs-literal">null</span>) {
        socks
          .in(<span class="hljs-string">"plant:"</span> + oid)
          .emit(<span class="hljs-string">"sunny::plant.tick"</span>, bot.cache.plants.get(oid));
      }
    });
  });

  sock.on(<span class="hljs-string">"sunny::plant.unsubscribe"</span>, ({ oid }) =&gt; {
    <span class="hljs-keyword">let</span> roomId = <span class="hljs-string">"plant:"</span> + oid;
    log(
      <span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) wants to stop subscribing to plant room: <span class="hljs-subst">${roomId}</span>`</span>
    );

    sock.leave(roomId, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> log(
          <span class="hljs-string">`failed to remove <span class="hljs-subst">${sock.id}</span> from from plant room(<span class="hljs-subst">${roomId}</span>) room due to err: <span class="hljs-subst">${err.message}</span>`</span>
        );
      <span class="hljs-keyword">if</span> (getRoomPopulation(roomId) === <span class="hljs-number">0</span>) {
        bot.removeSoloPlant(roomId.substr(<span class="hljs-string">"plant:"</span>.length));
      }
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Have to utilize the pre-disconnection event because
we need to know what plants were removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sock.on(<span class="hljs-string">"disconnecting"</span>, () =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> roomId <span class="hljs-keyword">in</span> sock.rooms) {
      <span class="hljs-keyword">if</span> (roomId === sock.id) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">if</span> (roomId === <span class="hljs-string">"aggregation"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Adding a timeout to account for refreshes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (getRoomPopulation(<span class="hljs-string">"aggregation"</span>) === <span class="hljs-number">0</span>) {
            log(<span class="hljs-string">`stopping aggregation`</span>);
            bot.stopAggregation();
          }
        }, <span class="hljs-number">5000</span>);
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">if</span> (roomId.indexOf(<span class="hljs-string">"plant:"</span>) === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>If this is the last socket in the room.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (getRoomPopulation(roomId) === <span class="hljs-number">1</span>) {
          log(
            <span class="hljs-string">`socket(<span class="hljs-subst">${sock.id}</span>) is unsubscribing from <span class="hljs-subst">${roomId.substr(
              <span class="hljs-string">"plant:"</span>.length
            )}</span>`</span>
          );
          bot.removeSoloPlant(roomId.substr(<span class="hljs-string">"plant:"</span>.length));
        }
      }
    }
  });

  sock.on(<span class="hljs-string">"disconnect"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(socks.engine.clientsCount , <span class="hljs-string">'client(s) are connected'</span>)
    <span class="hljs-keyword">if</span> (socks.engine.clientsCount === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (cacheClearTimeout) clearTimeout(cacheClearTimeout);
      cacheClearTimeout = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (socks.engine.clientsCount === <span class="hljs-number">0</span>) {
          log(<span class="hljs-string">'clearing bot cache'</span>);
          <span class="hljs-keyword">this</span>.cache = {
            <span class="hljs-attr">aggregation</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">plants</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>()
          };
        }
      }, <span class="hljs-number">10000</span>);
    }
  });
});

bot.on(<span class="hljs-string">"aggregation"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  log(<span class="hljs-string">"bot aggregation event recieved"</span>);
  socks.in(<span class="hljs-string">"aggregation"</span>).emit(<span class="hljs-string">"sunny::aggregation.tick"</span>, value);
});

bot.on(<span class="hljs-string">"solo_scrape"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
  log(<span class="hljs-string">`emitting solo_scrape data for <span class="hljs-subst">${value.oid}</span>`</span>);
  socks.in(<span class="hljs-string">"plant:"</span> + value.oid).emit(<span class="hljs-string">"sunny::plant.tick"</span>, value);
});

app.set(<span class="hljs-string">"view engine"</span>, <span class="hljs-string">"pug"</span>);

app.use(<span class="hljs-string">"/public"</span>, express.static(path.join(__dirname, <span class="hljs-string">"../public"</span>)));

app.get(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  res.render(<span class="hljs-string">"index"</span>);
});

app.bot = bot;

app.server = server;

<span class="hljs-built_in">module</span>.exports = app;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
